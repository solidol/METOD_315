\chapter{Серверні веб-додатки}

\section*{Анотація} 
Стандарт CGI. Сценарії. Сценарні мови: класифікація за швидкодією. Мова Python. Мова Ruby. Технологія ASP. Інтерфейс ISAPI.

\section*{План лекції}
\begin{enumerate}
\item Стандарт CGI
\item Обмін даними з CGI-сценарієм

\end{enumerate}

\section{Стандарт CGI}

Коло завдань, що вирішуються Web-сервером, обмежений. В основному він зводиться до підтримки НТТР-взаємодії і доставці клієнту Web-документів. Будь-які "нестандартні" дії реалізуються за допомогою спеціальної програми, яка взаємодіє з веб-сервером і клієнтом. Ця взаємодія підпорядковується певним правилам.

Основний набір таких правил - стандарт CGI (Common Gateway Interface - інтерфейс загального шлюзу), який визначає порядок запуску програми на комп'ютері-сервері, способи передачі програмі параметрів і доставки результатів її виконання клієнту. Програма, написана за правилами CGI, називається CGI-сценаріем (CGI script), хоча це не означає, що на сервері не може виконуватися двійковий файл.

Завдяки цьому інтерфейсу для розробки додатків можна використовувати будь-яка мова програмування, яка має в своєму розпорядженні засоби взаємодії зі стандартними пристроями введення / виводу. Такими можливостями володіють також сценарії для вбудованих командних інтерпретаторів операційних систем.

Виконання будь-якої програми (в тому числі CGI-сценарія) можна умовно розділити на п'ять етапів.
\begin{enumerate}
\item Запуск програми.
\item Ініціалізація і читання вихідних даних.
\item Обробка даних.
\item Висновок результатів виконання.
\item Завершення програми. 
\end{enumerate}
Відмінності між CGI-сценаріем і консольним додатком стосуються першого, другого і четвертого етапів виконання.

Кожен раз, коли веб-сервер отримує запит від клієнта, він аналізує вміст запиту і повертає відповідний відповідь:

    Якщо запит містить вказівку на файл, що знаходиться на жорсткому диску, то сервер повертає в складі відповіді цей файл;
    
    Якщо запит містить вказівку на програму і необхідні для неї аргументи, то сервер виконує програму і результат її роботи повертає клієнту. 

CGI визначає:

    яким чином інформація про сервер і запиті клієнта передається програмі в формі аргументів і змінних оточення;

    яким чином програма може передавати назад додаткову інформацію про результати (наприклад про тип даних) в формі заголовків відповіді сервера. 

Існує два способи розпізнавання файлів, що містять тексти CGI-сценаріев. Перший спосіб полягає в тому, що при установці веб-сервера один з каталогів спеціально виділяється для зберігання сценаріїв. Зазвичай такий каталог отримує ім'я cgi-bin (або Scripts для веб-сервера IIS). В цьому випадку, якщо клієнт запитує файл з каталогу cgi-bin, сервер сприймає такий запит як команду на запуск сценарію. Файли з інших каталогів інтерпретуються як HTML-документи.
    
    Другий спосіб використовує розширення файлу. Під час налаштування сервера вказується, що файли з певними розширеннями містять коди сценаріїв. 

Ідентифікація по розширенню використовується відносно рідко. Найчастіше всі сценарії поміщаються в cgi-bin, scripts або в інший каталог, спеціально виділений для їх зберігання.

Висновок результатів виконання CGI-сценарія здійснюється надзвичайно просто. Для того щоб дані були передані клієнту, досить вивести їх в стандартний вихідний потік. Однак, розробляючи CGI-сценарій, не слід забувати про те, що він все ж відрізняється від консольної програми і має такі особливості.

Інформація, передана клієнту, повинна відповідати протоколу HTTP, тобто складатися із заголовка і тіла відповіді. Як правило, отримавши дані від сценарію, сервер самостійно додає перший рядок заголовка.

  НТТР / 1.0 200 OK 

Формування інформаційних полів, що входять до складу заголовка, - завдання сценарію. Щоб дані, передані сценарієм, були правильно інтерпретовані клієнтом, необхідно, щоб в заголовку присутні як мінімум поле Content-type. За заголовком повинна слідувати порожній рядок. При відсутності полів заголовка реакція браузера буде непередбачуваною. У подібних випадках браузер зазвичай намагається відобразити отриману інформацію як текстовий файл.

Найприродніший формат для браузера - формат HTML. Результати роботи сценарію зазвичай оформляються у вигляді веб-сторінки, тобто повертаються дані слід доповнити дескрипторами HTML. Таким чином, відповідь CGI -сценарія клієнту зазвичай виглядає так:
\begin{verbatim}
 Content-type: text/html
 
 <Html>
 <Hеаd>
 <Titlе> відповідь сценарію </titlе>
 </ Hеаd>
 <Body>
 ........................
 </ Body>
 </ Html> 
\end{verbatim}


Зверніть увагу на порожній рядок після вираження Content-type: text/html. Вона обов'язково має бути присутня у відповіді, в іншому випадку клієнт сприйме всі наступні дані як продовження заголовка.

Після компіляції програми необхідно скопіювати виконуваний файл в каталог cgi-bin (або в інший каталог, призначений для розміщення виконуваних файлів) з якого він може запускатися веб-сервером на виконання за запитом клієнта.

\section{Обмін даними з CGI-сценарієм}

Для виклику даного сценарію досить включити в веб-сторінку наступний фрагмент HTML-коду:
\begin{verbatim}
 <form method = "post" action = "/cgi-bin/hello.exe">
 <input type = "submit"> 
 </form> 
\end{verbatim}
Якщо сценарій викликається з форми, йому передаються ті дані, які користувач ввів за допомогою інтерактивних елементів, що відображаються на веб-сторінці - передача інформації CGI-сценарію здійснюється в два етапи: спочатку браузер передає дані веб-сервера, потім веб-сервер передає їх сценарієм.

У більшості випадків крім кнопки Submit форма містить інші інтерактивні елементи, кожен з яких має ім'я ( атрибут NAME) і значення ( атрибут VALUE, або послідовність символів, введена користувачем). З імен елементів і їх значень формується рядок параметрів, яка має такий вигляд.

  ім'я = значення \& ім'я = значення \&.  .  .  \& Ім'я = значення 

кожен параметр являє собою ім'я керуючого елемента та його значення, розділені знаком рівності, а кілька таких пар об'єднують рядок за допомогою символу "\&". Якщо до складу імені або значення входить символ "\&" або "=", то подібні символи кодуються послідовність знака відсотка "\%", за яким слідують дві шістнадцяткові цифри, що визначають код символу. Так, наприклад, послідовністю "\%21" кодується знак оклику "!". Як правило, при передачі параметрів трехсімвольнимі послідовностями замінюються всі знаки, крім латинських букв, цифр і символу пробілу (останній замінюється знаком" +").

Таким чином, перед використанням рядка параметрів її треба декодувати. Алгоритм декодування надзвичайно простий і включає в себе наступні дії:

    Виділити з рядка параметрів пари ім'я = значення.
    Виділити з кожної пари ім'я і значення.
    У кожному імені і кожному значенні замінити символи "+" пробілами.
    Кожну послідовність з символу "\%" і двох шістнадцятирічних і перетворити в ASCII-символ. 

Атрибут method дескриптора <form> має або значення "GET", або значення "POST". Значення "GET" і "POST" визначають два різних методу передачі параметрів сценарієм:

    Якщо атрибут method має значення "GET", рядок параметрів передається разом з URL викликається сценарію. Роздільником між URL і рядком параметрів є символ "?".
    Якщо атрибут method має значення "POST", рядок параметрів передається в тілі HTTP-запиту. 

Розглянемо, як повинен вести себе CGI - сценарій, щоб правильно обробити дані в залежності від методу, використаного при передачі даних, рядок параметрів доставляється CGI -сценарію різними способами.

якщо атрибут METHOD дескриптора <FORM> мав значення "GET", рядок параметр передається серверу в якості значення змінної оточення QUERY\_STRING.

При використанні методу POST дані доставляються сценарієм по-іншому. Вони передаються через стандартний потік введення (STDIN). щоб сценарій зміг визначити, скільки символів слід читати зі стандартного вводу, веб- сервер встановлює значення змінної оточення CONTENT\_LENGTH, рівним довжині рядка параметрів.

Отримавши управління, сценарій в першу чергу повинен з'ясувати, з допомогою якого методу виконувалася передача параметрів. ця інформація міститься в змінній оточення REQUEST\_METHOD.

Таким чином, в простому випадку, щоб виконати обробку рядка параметрів, досить знати призначення трьох змінних оточення: REQUEST\_METHOD, QUERY\_STRING і CONTENT\_LENGTH.

Приклад сценарію на мові Perl, який повертає клієнту рядок параметрів, наведено нижче. Сценарій визначає, який метод використовувався для передачі даних, читає рядок параметрів і передає її клієнту, попередньо доповнивши HTML-дескрипторами.
\begin{verbatim}
 $Method = $ENV{'REQUEST_METHOD'};

 if ($ method eq "GET")
 {$pars = $ ENV{'QUERY_STRING'};  }
 else
 {$length = $ENV{'CONTENT_LENGTH'};  }

 read (STDIN, $pars, $length);

 print "Content-type: text/html \n\n";
 print "<HTML> <BODY> \n";
 print "<P> METHOD =", $ method;
 print "<P> String of parameters: <P> \n";
 print $ pars;
 print "</HTML> </BODY> \n"; 
 \end{verbatim}
 
